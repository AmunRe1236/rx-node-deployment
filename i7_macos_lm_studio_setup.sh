#!/bin/bash

# üñ•Ô∏è GENTLEMAN i7 Node (macOS) LM Studio Setup
# macOS-optimized LM Studio installation for CPU inference
# Target: i7 Node (192.168.68.105) - macOS system

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${PURPLE}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üñ•Ô∏è GENTLEMAN i7 NODE (macOS) LM STUDIO SETUP               ‚ïë
‚ïë  CPU Optimized LM Studio Installation for macOS             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"

# Configuration
LM_STUDIO_PORT="1235"  # Different port from RX node (1234)
INSTALL_DIR="$HOME/i7-lmstudio"
SERVICE_NAME="i7-lmstudio"

echo -e "${BLUE}üöÄ Starting i7 Node (macOS) LM Studio Setup...${NC}"
echo -e "${YELLOW}üìç Target: i7 CPU-based inference (macOS)${NC}"
echo -e "${YELLOW}üìÖ Date: $(date)${NC}"
echo -e "${YELLOW}üîß Port: $LM_STUDIO_PORT (i7-specific)${NC}"
echo

# Function to log steps
log_step() {
    echo -e "${CYAN}üîπ $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Step 1: System Information (macOS)
log_step "Step 1: macOS System Information"
echo "üñ•Ô∏è  Hostname: $(hostname)"
echo "üåê IP Address: $(ifconfig | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | head -1)"
echo "üíª OS: $(sw_vers -productName) $(sw_vers -productVersion)"
echo "üß† CPU: $(sysctl -n machdep.cpu.brand_string)"
echo "üî¢ CPU Cores: $(sysctl -n hw.ncpu) cores"
echo "üíæ RAM: $(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 ))GB"
echo "üíø Disk Space: $(df -h / | awk 'NR==2 {print $4}') available"

log_success "macOS System information collected"

# Step 2: CPU Features Check (macOS)
log_step "Step 2: macOS CPU Features Check"
echo "üîç Checking CPU features for AI optimization:"

# Check macOS CPU features
CPU_FEATURES=""
if sysctl -n machdep.cpu.features | grep -q "AVX2"; then
    echo "  ‚úÖ AVX2 support detected"
    CPU_FEATURES="$CPU_FEATURES avx2"
fi

if sysctl -n machdep.cpu.leaf7_features | grep -q "AVX512"; then
    echo "  ‚úÖ AVX-512 support detected"
    CPU_FEATURES="$CPU_FEATURES avx512"
fi

if sysctl -n machdep.cpu.features | grep -q "FMA"; then
    echo "  ‚úÖ FMA support detected"
    CPU_FEATURES="$CPU_FEATURES fma"
fi

if [ -n "$CPU_FEATURES" ]; then
    log_success "CPU features for AI acceleration: $CPU_FEATURES"
else
    log_warning "Limited CPU AI acceleration features detected"
fi

# Step 3: Check for Homebrew
log_step "Step 3: Homebrew Check"
if command -v brew >/dev/null 2>&1; then
    log_success "Homebrew detected"
    brew update || log_warning "Homebrew update failed"
else
    log_warning "Homebrew not found - manual installation may be needed"
fi

# Step 4: Create Installation Directory
log_step "Step 4: Creating Installation Directory"
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"
log_success "Installation directory created: $INSTALL_DIR"

# Step 5: Download LM Studio for macOS
log_step "Step 5: Downloading LM Studio for macOS"

# Check if already downloaded
if [ -f "$INSTALL_DIR/LMStudio-0.2.29.dmg" ]; then
    log_success "LM Studio DMG already exists"
else
    # Download LM Studio for macOS
    LM_STUDIO_URL="https://releases.lmstudio.ai/mac/0.2.29/LMStudio-0.2.29.dmg"
    curl -L -o "LMStudio-0.2.29.dmg" "$LM_STUDIO_URL" || {
        log_error "Download failed - continuing with existing setup"
    }
fi

# Step 6: Create LM Studio wrapper script for macOS
log_step "Step 6: Creating macOS LM Studio wrapper script"
cat > "$INSTALL_DIR/start_i7_lmstudio_macos.sh" << 'EOF'
#!/bin/bash

# üñ•Ô∏è i7 LM Studio Startup Script (macOS)
# Optimized for Intel CPU inference on macOS

# macOS CPU optimizations
export OMP_NUM_THREADS=$(sysctl -n hw.ncpu)
export VECLIB_MAXIMUM_THREADS=$(sysctl -n hw.ncpu)

# Memory optimizations for macOS
export MALLOC_ARENA_MAX=2

INSTALL_DIR="$HOME/i7-lmstudio"
cd "$INSTALL_DIR"

echo "üñ•Ô∏è Starting i7 LM Studio with macOS CPU optimizations..."
echo "üß† Using $(sysctl -n hw.ncpu) CPU threads"
echo "üîß Port: 1235 (i7-specific)"
echo "üìç Node: i7 CPU Inference (macOS)"
echo "üíª System: $(sw_vers -productName) $(sw_vers -productVersion)"

# Check if LM Studio app exists
if [ -d "/Applications/LM Studio.app" ]; then
    echo "üöÄ Starting LM Studio app..."
    open "/Applications/LM Studio.app"
    echo "üì± LM Studio GUI started - configure server on port 1235"
else
    echo "‚ùå LM Studio app not found in /Applications/"
    echo "üì• Please install LM Studio manually from the DMG file"
    echo "üîó Or download from: https://lmstudio.ai"
fi

echo ""
echo "üîß Manual Configuration Steps:"
echo "1. Open LM Studio"
echo "2. Go to Local Server tab"
echo "3. Set port to 1235"
echo "4. Enable 'Serve on Local Network'"
echo "5. Start server"
echo ""
echo "üß™ Test server with:"
echo "curl http://localhost:1235/v1/models"
EOF

chmod +x "$INSTALL_DIR/start_i7_lmstudio_macos.sh"
log_success "macOS LM Studio wrapper script created"

# Step 7: Create test script
log_step "Step 7: Creating i7 LM Studio test script"
cat > "$INSTALL_DIR/test_i7_lmstudio.sh" << 'EOF'
#!/bin/bash

# üß™ i7 LM Studio Test Script (macOS)

echo "üß™ Testing i7 LM Studio (macOS)..."
echo "üìç Node: $(hostname) ($(ifconfig | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | head -1))"
echo "üîß Port: 1235"
echo ""

# Test 1: Port availability
echo "üîç Test 1: Port 1235 availability"
if lsof -i :1235 >/dev/null 2>&1; then
    echo "‚úÖ Port 1235 is in use (LM Studio likely running)"
else
    echo "‚ùå Port 1235 is free (LM Studio not running)"
fi

# Test 2: API endpoint test
echo ""
echo "üîç Test 2: LM Studio API test"
if curl -s --connect-timeout 5 http://localhost:1235/v1/models >/dev/null 2>&1; then
    echo "‚úÖ LM Studio API responding"
    echo "üìä Models available:"
    curl -s http://localhost:1235/v1/models | python3 -m json.tool 2>/dev/null || echo "JSON parsing failed"
else
    echo "‚ùå LM Studio API not responding"
    echo "üí° Start LM Studio with: ./start_i7_lmstudio_macos.sh"
fi

# Test 3: Cross-node connectivity test
echo ""
echo "üîç Test 3: Cross-node connectivity to RX Node"
RX_NODE_IP="192.168.68.117"
if ping -c 2 "$RX_NODE_IP" >/dev/null 2>&1; then
    echo "‚úÖ RX Node ($RX_NODE_IP) reachable"
    
    # Test RX Node LM Studio
    if curl -s --connect-timeout 5 "http://$RX_NODE_IP:1234/v1/models" >/dev/null 2>&1; then
        echo "‚úÖ RX Node LM Studio API responding on port 1234"
        echo "üîó Cross-node LM Studio communication possible"
    else
        echo "‚ùå RX Node LM Studio API not responding"
    fi
else
    echo "‚ùå RX Node ($RX_NODE_IP) not reachable"
fi

echo ""
echo "üéØ i7 LM Studio Test completed"
EOF

chmod +x "$INSTALL_DIR/test_i7_lmstudio.sh"
log_success "i7 LM Studio test script created"

# Step 8: Create cross-node test script
log_step "Step 8: Creating Cross-Node LM Studio Test"
cat > "$INSTALL_DIR/cross_node_lm_test.sh" << 'EOF'
#!/bin/bash

# üîó Cross-Node LM Studio Test Script
# Tests communication between i7 Node (1235) and RX Node (1234)

echo "üîó Cross-Node LM Studio Communication Test"
echo "=========================================="
echo "i7 Node (CPU): Port 1235"
echo "RX Node (GPU): Port 1234"
echo ""

# Configuration
I7_PORT="1235"
RX_NODE_IP="192.168.68.117"
RX_PORT="1234"
I7_IP=$(ifconfig | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | head -1)

echo "üìç i7 Node: $I7_IP:$I7_PORT"
echo "üìç RX Node: $RX_NODE_IP:$RX_PORT"
echo ""

# Test 1: i7 Node LM Studio Status
echo "üñ•Ô∏è Test 1: i7 Node LM Studio Status"
if curl -s --connect-timeout 5 "http://localhost:$I7_PORT/v1/models" >/dev/null 2>&1; then
    echo "‚úÖ i7 LM Studio (CPU) responding on port $I7_PORT"
    I7_MODELS=$(curl -s "http://localhost:$I7_PORT/v1/models" | python3 -c "import sys,json; data=json.load(sys.stdin); print(len(data.get('data', [])))" 2>/dev/null || echo "0")
    echo "üìä i7 Models loaded: $I7_MODELS"
else
    echo "‚ùå i7 LM Studio (CPU) not responding"
fi

echo ""

# Test 2: RX Node LM Studio Status
echo "üéÆ Test 2: RX Node LM Studio Status"
if curl -s --connect-timeout 5 "http://$RX_NODE_IP:$RX_PORT/v1/models" >/dev/null 2>&1; then
    echo "‚úÖ RX LM Studio (GPU) responding on port $RX_PORT"
    RX_MODELS=$(curl -s "http://$RX_NODE_IP:$RX_PORT/v1/models" | python3 -c "import sys,json; data=json.load(sys.stdin); print(len(data.get('data', [])))" 2>/dev/null || echo "0")
    echo "üìä RX Models loaded: $RX_MODELS"
else
    echo "‚ùå RX LM Studio (GPU) not responding"
fi

echo ""

# Test 3: Performance Comparison Test
echo "‚ö° Test 3: Performance Comparison (if both available)"
if curl -s --connect-timeout 5 "http://localhost:$I7_PORT/v1/models" >/dev/null 2>&1 && \
   curl -s --connect-timeout 5 "http://$RX_NODE_IP:$RX_PORT/v1/models" >/dev/null 2>&1; then
    
    echo "üß™ Running performance comparison test..."
    
    # Simple test prompt
    TEST_PROMPT="Hello, how are you?"
    
    echo "üìù Test prompt: '$TEST_PROMPT'"
    echo ""
    
    # Test i7 (CPU) performance
    echo "üñ•Ô∏è Testing i7 Node (CPU) performance..."
    I7_START=$(date +%s.%N)
    I7_RESPONSE=$(curl -s --connect-timeout 30 -X POST "http://localhost:$I7_PORT/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -d "{\"model\":\"local\",\"messages\":[{\"role\":\"user\",\"content\":\"$TEST_PROMPT\"}],\"max_tokens\":50}" 2>/dev/null || echo "ERROR")
    I7_END=$(date +%s.%N)
    I7_TIME=$(echo "$I7_END - $I7_START" | bc 2>/dev/null || echo "N/A")
    
    if [ "$I7_RESPONSE" != "ERROR" ]; then
        echo "‚úÖ i7 Response time: ${I7_TIME}s"
    else
        echo "‚ùå i7 Test failed"
    fi
    
    echo ""
    
    # Test RX (GPU) performance
    echo "üéÆ Testing RX Node (GPU) performance..."
    RX_START=$(date +%s.%N)
    RX_RESPONSE=$(curl -s --connect-timeout 30 -X POST "http://$RX_NODE_IP:$RX_PORT/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -d "{\"model\":\"local\",\"messages\":[{\"role\":\"user\",\"content\":\"$TEST_PROMPT\"}],\"max_tokens\":50}" 2>/dev/null || echo "ERROR")
    RX_END=$(date +%s.%N)
    RX_TIME=$(echo "$RX_END - $RX_START" | bc 2>/dev/null || echo "N/A")
    
    if [ "$RX_RESPONSE" != "ERROR" ]; then
        echo "‚úÖ RX Response time: ${RX_TIME}s"
    else
        echo "‚ùå RX Test failed"
    fi
    
    echo ""
    echo "üìä Performance Summary:"
    echo "   üñ•Ô∏è i7 (CPU): ${I7_TIME}s"
    echo "   üéÆ RX (GPU): ${RX_TIME}s"
    
else
    echo "‚ö†Ô∏è Both nodes must be running for performance comparison"
fi

echo ""
echo "üéØ Cross-Node Test completed"
echo ""
echo "üí° Usage:"
echo "   Start i7: ./start_i7_lmstudio_macos.sh"
echo "   Test i7:  ./test_i7_lmstudio.sh"
echo "   Cross-test: ./cross_node_lm_test.sh"
EOF

chmod +x "$INSTALL_DIR/cross_node_lm_test.sh"
log_success "Cross-node LM Studio test script created"

# Final summary
echo ""
log_success "i7 Node (macOS) LM Studio Setup completed!"
echo ""
echo -e "${GREEN}üìä Setup Summary:${NC}"
echo "   üìÅ Installation Directory: $INSTALL_DIR"
echo "   üîß Port: $LM_STUDIO_PORT (i7-specific)"
echo "   üñ•Ô∏è Platform: macOS optimized"
echo "   üß™ Test Scripts: Available"
echo ""
echo -e "${BLUE}üöÄ Next Steps:${NC}"
echo "   1. Install LM Studio manually: open LMStudio-0.2.29.dmg"
echo "   2. Start LM Studio: ./start_i7_lmstudio_macos.sh"
echo "   3. Test i7 LM Studio: ./test_i7_lmstudio.sh"
echo "   4. Cross-node test: ./cross_node_lm_test.sh"
echo ""
echo -e "${YELLOW}üí° Manual Configuration:${NC}"
echo "   - Open LM Studio GUI"
echo "   - Configure Local Server on port 1235"
echo "   - Enable 'Serve on Local Network'"
echo "   - Load a model and start server"
echo ""
echo -e "${CYAN}üîó Cross-Node Testing:${NC}"
echo "   - i7 Node (CPU): http://localhost:1235"
echo "   - RX Node (GPU): http://192.168.68.117:1234"
echo "   - Performance comparison available" 